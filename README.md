# social_network_system_design

System Design социальной сети для курса по System Design

Функциональные требования:
- Публикация и просмотр постов
- Публикации содержат медифайлы, небольшие описания.
- Публикация  содержит привязку к месту.
- Пользователи могут ставить оценки постам
- Пользователи могут комментировать посты
- Пользователи могут подписываться и отписываться на/от других пользователей
- Поиск и просмотр мест
- Формирование и просмотр ленты с постами для пользователя в обратном хронологическом порядке
- Формирование и просмотр ленты  с постами связанными с местом.
Нефункциональные требования:
- DAU 10 000 000
- Доступность 99.99%
- СНГ аудитория
- Есть высокий сезон
   - Летние отпуска (май - сентябрь)
   - Зимние каникулы (конец декабря - середина января)
- Данные храним всегда
- Активность пользователя:
  - в среднем создает 0.2 поста в день
  - в среднем 10 раз в день загружает ленту
  - в среднем ставит 7 реакций в день
  - в среднем оставляет 4 комментария в день
  - в среднем читает комментарии 6 комментария в день
  - в среднем подписываемся 0.1 раза в день
- Активность пользователя в сезон
  - в среднем создает 1 пост в день
  - в среднем 15 раз в день загружает ленту
  - в среднем ставит 20 реакций в день
  - в среднем оставляет 8 комментария в день
  - в среднем читает комментарии 10 комментария в день
  - в среднем подписываемся 0.4 раза в день
- Лимиты
  - 50 постов в день
  - 1к запросов на чтение в день
  - 1к комментариев в день
  - 5к реакций в день
  - 5 медиафайлов в 1 посте
  - размер файла не превышает 500KB
  - Описание не превышает 256 символов.
- Тайминги
  - 1с на запрос публикации поста
  - 1с на запрос создания реакции
  - 2с на запрос создания комментарий
  - 3с на запрос поиска места
  - 4c на запрос чтения мест
  - 5с на запрос чтения постов
  - 2с на запрос чтения комментариев 
  - 2с на запрос чтения реакций
  
Расчет нагрзки:
- RPS write (посты) = 10 000 000 * 0.2 / 86 400 = 24 RPS
- RPS write (реакции) = 10 000 000 * 7 / 86 400 = 810 RPS
- RPS write (комментарии) = 10 000 000 * 4 / 86 400 = 500 RPs
- RPS read (посты) = 10 000 000 * 10 / 86 400 = 1200 RPS
- RPS read (реакции, тк выводим вместе с постом) = 10 000 000 * 10 / 86 400 = 1200 RPS
RPS read (комментарий) = 10 000 000 * 6 / 86 400 = 700 RPS
- RPS (подписки) = 10 000 000 * 0.1 / 86 400 = 12 RPS
Расчет нагрзки в сезон:
- RPS write (посты) = 10 000 000 * 1 / 86 400 = 120 RPS
- RPS write (реакции) = 10 000 000 * 20 / 86 400 = 2300 RPS
- RPS write (комментарии) = 10 000 000 * 8 / 86 400 = 1000 RPs
- RPS read (посты) = 10 000 000 * 15 / 86 400 = 1800 RPS
- RPS read (реакции, тк выводим вместе с постом) = 10 000 000 * 15 / 86 400 = 1800 RPS
- RPS read (комментарий) = 10 000 000 * 10 / 86 400 = 1200 RPS
- RPS (подписки) = 10 000 000 * 0.4 / 86 400 = 47 RPS

Расчет трафика:
Трафик запись постов(метаинформация) = 24 * 1500Б = 153KБ/с
Трафик запись постов(медиа) = 24 * 500KB = 12 MB/c
Трафик на чтение постов = 1200 * 1500Б = 1.8 MB
Трафик на запись комментария = 500 * 200B = 10000B/с = 10 KB/c
Трафик на запись реакций = 810 * 100B = 81000B/c = 81KB/C
Трафик подписок = 12 * 100B = 1200B/c = 1.2KB/c

Расчет трафика в сезон:
Трафик запись постов(метаинформация) = 120 * 1500Б = 180KБ/с
Трафик запись постов(медиа) = 120 * 500KB = 60 MB/c
Трафик на чтение постов = 1800 * 1500Б = 2.7 MB
Трафик на запись комментария = 1000 * 200B = 10000B/с = 200 KB/c
Трафик на запись реакций = 2300 * 100B = 81000B/c = 230 KB/C
Трафик подписок = 47 * 100B = 4700B/c = 4.7KB/c

Расчет дисков:

Посты без медиа
Capasity  =  180 * 86400 * 365 = 5 676 480 000 KB = 6 TB
disk_capacity SSD (SATA) = 100 TB
Disks_for_capacity = 6 / 100 = 0.06
Disks_for_throughput = 180KB/c / 100 MB/c =  0,0018
Disks_for_iops = 1920 / 1000 = 1.9
Disks = 3 по 2 TB

Медиа для постов
Capasity  =  60 * 86400 * 365 = 1 892 160 000 MB = 1,9PB
disk_capacity SSD (SATA) = 100 TB
disk_capacity HDD = 32 TB
Disks_for_capacity = 1900 / 100 = 19
Disks_for_capacity HDD= 1900 / 32 = 60
Disks_for_throughput = 60 MB/c / 100 MB/c =  0.6
Disks_for_iops = 1920 / 1000 = 1.9
Disks горячее хранилище = 10 по 100 TB(ssd) 
Disks холодное хранилище = 32 по 32 TB(hdd)
Комментарии
Capasity  =  200 * 86400 * 365 = 6 307 200 000 KB = 6.5 TB
disk_capacity SSD (SATA) = 100 TB
Disks_for_capacity =6.5 / 100 = 0.065
Disks_for_throughput = 200 KB/c / 100 MB/c =  0,002
Disks_for_iops = 2200 / 1000 = 2.2
Disks = 3 по 3 TB

Реакции 
Capasity  =  230 * 86400 * 365 = 7 253 280 000 KB = 7.3 TB
disk_capacity SSD (SATA) = 100 TB
Disks_for_capacity =7.3 / 100 = 0.073
Disks_for_throughput = 230 KB/c / 100 MB/c =  0,0023
Disks_for_iops = 4100 / 1000 = 4.1
Disks = 5 по 2 TB

Подписки
Capasity  =  4.7 * 86400 * 365 = 148 219 200 KB = 0.2 TB
disk_capacity SSD (SATA) = 100 TB
Disks_for_capacity =0.2 / 100 = 0.002
Disks_for_throughput = 4.7 KB/c / 100 MB/c =  0,047
Disks_for_iops = 4.7 / 1000 = 0,0047
Disks = 1 по 1 TB

БД:
Поскольку для надежности желательно размещать сервера в нескольких дц, так же приложение ориентированно на путешествия, поэтому желательно, чтобы трафик быстрее доходил до ДЦ их популярных туристических направлений(Азия, Ближний восток, Европа). Следовательно желательно размещеться в трех дц.
Один в европейской части(Москва/Санкт-Петербург), в крупном городе на юге страны (Сочи), а так же на востоке (Владивосток).

PostgreSQL: async + sync по одной реплики на каждый вид
RF 3. Поскольку размещаемся в нескольких дц, то используем master-master. В европейской части master и sync реплика. В остальных дц по master + async.

Используем как основную базу данных, в которой храним посты(без медиа), комментарии, подписки, реаккции.

S3:
Cross-Region Replication и sync
RF 3. Поскольку размещаемся в нескольких дц, то используем master-master.
В европейской части master + sync. В остальных Cross-Region Replication + master.
Используем для хранения медиафайлов для постов.

Redis:
async RF 2.
Поскольку размещаемся в нескольких дц, то используем master-master.
В каждом дц по master + async.
Кешируем самых популярных пользователей(10 последних постов+ 10 комментариев и каунт реакций).


Шардировать будем postgres.
Расчеты дисков:

Посты:
Комбинированный Key based по user_id.
Hosts = 3 / 1 = 3
Hosts_with_replication = 3 * 6 = 18

Медиа: 
Комбинированный Key based по user_id.
Hosts = 10 / 1 = 10
Hosts_with_replication = 10 * 6 = 60

Комментарии: 
Комбинированный Key based по user_id.
Hosts = 3 / 1 = 3
Hosts_with_replication = 3 * 6 = 18

Реакции: 
Комбинированный Key based по user_id.
Hosts = 5 / 1 = 5
Hosts_with_replication = 5 * 6 = 30

Подписки
Комбинированный Key based по user_id.
Hosts = 1 / 1 = 1
Hosts_with_replication = 1 * 6 = 6